üöÄ MASTER PROMPT: T√çCH H·ª¢P VNPAY SANDBOX (Chu·∫©n t√†i li·ªáu)
Vai tr√≤: B·∫°n l√† Senior Backend Developer chuy√™n v·ªÅ Node.js v√† Payment Gateway. Nhi·ªám v·ª•: T√≠ch h·ª£p c·ªïng thanh to√°n VNPAY v√†o d·ª± √°n Scamphone (MERN Stack) d·ª±a tr√™n t√†i li·ªáu k·ªπ thu·∫≠t ch√≠nh th·ª©c.

Th√¥ng tin c·∫•u h√¨nh (Sandbox):

vnp_TmnCode: 8DW7N5W5

vnp_HashSecret: Y473FV82V4439K5FP4U9MNONIVJ6PC89

vnp_Url: https://sandbox.vnpayment.vn/paymentv2/vpcpay.html

vnp_ReturnUrl: http://localhost:5173/payment-result (Frontend Route s·∫Ω t·∫°o sau ƒë·ªÉ h·ª©ng k·∫øt qu·∫£)

Y√™u c·∫ßu tri·ªÉn khai chi ti·∫øt:
1. Backend (Scamphone-BE)

C√†i ƒë·∫∑t th∆∞ vi·ªán: S·ª≠ d·ª•ng moment (ƒë·ªÉ format ng√†y), qs (ƒë·ªÉ stringify query), v√† crypto (c√≥ s·∫µn trong Node.js).

T·∫°o Controller: Controllers/paymentController.js v·ªõi 2 h√†m ch√≠nh:

H√†m createPaymentUrl(req, res):

Nh·∫≠n amount, orderId, bankCode (optional), language (m·∫∑c ƒë·ªãnh 'vn') t·ª´ req.body.

L·∫•y IP: var ipAddr = req.headers['x-forwarded-for'] || req.connection.remoteAddress...

T·∫°o b·ªô tham s·ªë vnp_Params g·ªìm: vnp_Version ('2.1.0'), vnp_Command ('pay'), vnp_TmnCode, vnp_Locale, vnp_CurrCode ('VND'), vnp_TxnRef (l√† orderId), vnp_OrderInfo ('Thanh toan don hang...'), vnp_OrderType ('other'), vnp_Amount (amount * 100), vnp_ReturnUrl, vnp_IpAddr, vnp_CreateDate (format YYYYMMDDHHmmss).

QUAN TR·ªåNG: Ph·∫£i th·ª±c hi·ªán s·∫Øp x·∫øp (sort) object vnp_Params theo key (a-z) tr∆∞·ªõc khi k√Ω.

T·∫°o chu·ªói k√Ω (signData) t·ª´ c√°c tham s·ªë ƒë√£ sort.

T·∫°o ch·ªØ k√Ω (secureHash) b·∫±ng thu·∫≠t to√°n HMAC SHA512 v·ªõi key vnp_HashSecret.

Th√™m vnp_SecureHash v√†o cu·ªëi URL.

Tr·∫£ v·ªÅ URL thanh to√°n ho√†n ch·ªânh.

H√†m vnpayReturn(req, res) (X·ª≠ l√Ω IPN/Return):

Nh·∫≠n c√°c tham s·ªë t·ª´ req.query.

L·∫•y vnp_SecureHash ra ri√™ng v√† x√≥a kh·ªèi object tham s·ªë ƒë·ªÉ ki·ªÉm tra.

X√≥a c·∫£ vnp_SecureHashType (n·∫øu c√≥).

S·∫Øp x·∫øp (sort) l·∫°i c√°c tham s·ªë c√≤n l·∫°i theo a-z.

T·∫°o l·∫°i ch·ªØ k√Ω v√† so s√°nh v·ªõi vnp_SecureHash nh·∫≠n ƒë∆∞·ª£c.

N·∫øu ch·ªØ k√Ω kh·ªõp V√Ä vnp_ResponseCode === '00':

C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng (OrderModel) th√†nh isPaid = true, paymentMethod = 'VNPAY'.

L∆∞u th√¥ng tin v√†o PaymentModel.

Redirect v·ªÅ Frontend ho·∫∑c tr·∫£ v·ªÅ k·∫øt qu·∫£ JSON th√†nh c√¥ng.

N·∫øu ch·ªØ k√Ω sai ho·∫∑c l·ªói: Tr·∫£ v·ªÅ th√¥ng b√°o l·ªói.

T·∫°o Route: Routes/paymentRoutes.js

POST /create_payment_url

GET /vnpay_return

2. Frontend (Scamphone-FE)

Trang PaymentPage.tsx:

Khi ng∆∞·ªùi d√πng ch·ªçn "Thanh to√°n VNPAY" v√† b·∫•m n√∫t:

G·ªçi API t·∫°o ƒë∆°n h√†ng (createOrder) tr∆∞·ªõc ƒë·ªÉ l·∫•y _id ƒë∆°n h√†ng.

G·ªçi API POST /create_payment_url v·ªõi orderId v√† amount.

Nh·∫≠n URL tr·∫£ v·ªÅ v√† chuy·ªÉn h∆∞·ªõng: window.location.href = response.paymentUrl.

Trang PaymentResultPage.tsx (T·∫°o m·ªõi):

D√πng ƒë·ªÉ ƒë√≥n user quay l·∫°i t·ª´ VNPAY (Route /payment-result).

L·∫•y c√°c query params t·ª´ URL.

G·ªçi API GET /vnpay_return c·ªßa Backend ƒë·ªÉ x√°c th·ª±c k·∫øt qu·∫£ cu·ªëi c√πng.

N·∫øu th√†nh c√¥ng: Hi·ªÉn th·ªã "Thanh to√°n th√†nh c√¥ng" v√† n√∫t v·ªÅ trang ch·ªß.

N·∫øu th·∫•t b·∫°i: Hi·ªÉn th·ªã l·ªói v√† n√∫t quay l·∫°i trang thanh to√°n.

H√£y code c·∫©n th·∫≠n ph·∫ßn t·∫°o ch·ªØ k√Ω (Secure Hash) v√¨ ƒë√¢y l√† ph·∫ßn d·ªÖ sai nh·∫•t theo t√†i li·ªáu VNPAY.